# HDFS 常见问题

#### 1. 副本默认存放策略？

* 如果写请求方所在机器是其中一个 datanode ，则直接存放在本地，否则随机在集群中选择一个 datanode 。


* 第二个副本存放于不同第一个副本的所在的机架。
* 第三个副本存放于第二个副本所在的机架，但是属于不同的节点。

#### 2. hdfs 缓存适用场景？

1. 公共资源文件，比如一些 jar 包等。
2. 热点数据。如 hive 中常用到的表或者部分分区对应的 hdfs 文件。

#### 3. hdfs 如何做到不允许多个客户端并发写？

通过 Lease（租约），Lease 可以看做是一把带时间限制的写锁，仅持有写锁的客户端可以写文件。

#### 4. 租约相关定义？

* 每个客户端用户持有一个租约。
* 每个租约内部包含有一个租约持有者信息，还有此租约对应的文件 Id 列表，表示当前租约持有者正在写这些文件 Id 对应的文件。
* 每个租约内包含有一个最新近更新时间，最近更新时间将会决定此租约是否已过期。过期的租约会导致租约持有者无法继续执行写数据到文件中，除非进行租约的更新。

#### 5. 租约何时释放？

- 客户端显式地请求 NameNode 对某个文件进行 recoverLease 操作；
- Lease 超过 softLimit（默认1m），此时另一客户端申请该文件 Lease；
- Lease 超过 harLimit（默认1h），由 Namenode 的 lmthread 线程发现并执行释放；


#### 6. HDFS 的元数据如何存储？

hdfs 的元数据存储在 NameNode 节点的本地文件中，目录结构如下：

![](../img/hdfs/metadata.png)

NameNode 在执行 HDFS 客户端提交的创建文件或者移动文件这样的写操作的时候，会**首先把这些操作记录在 EditLog 文件**之中，然后**再更新内存中的文件系统镜像**。

NameNode 会**定期对内存中的文件系统镜像进行 checkpoint 操作**，在磁盘上生成 FSImage 文件，FSImage 文件的文件名形如 fsimage_${end_txid}，其中 ${end_txid} 表示这个 fsimage 文件的结束事务 id。