# 三阶段提交协议

与两阶段提交不同的是，三阶段提交是“非阻塞”协议。三阶段提交在两阶段提交的第一阶段与第二阶段之间插入了一个准备阶段，使得原先在两阶段提交中，参与者在投票之后，由于协调者发生崩溃或错误，而导致参与者处于无法知晓是否提交或者中止的“不确定状态”所产生的可能相当长的延时的问题得以解决。 

![](../img/distribute/3pc.png)

## 详细过程

### 第一阶段（CanCommit阶段）：

1.事务询问 协调者向参与者发送CanCommit请求。询问是否可以执行事务提交操作。然后开始等待参与者的响应。
2.响应反馈 参与者接到CanCommit请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返回Yes响应，并进入预备状态。否则反馈No

### 第二阶段（PreCommit阶段）

根据响应情况，有以下两种可能——

* 假如协调者从所有的参与者获得的反馈都是Yes响应，那么就会执行事务的预执行。
    1. **发送预提交请求**：协调者向参与者发送PreCommit请求，并进入Prepared阶段。
    2. **事务预提交**：参与者接收到PreCommit请求后，会执行事务操作，并将undo和redo信息记录到事务日志中。
    3. **响应反馈**：如果参与者成功的执行了事务操作，则返回ACK响应，同时开始等待最终指令。

* 假如有任何一个参与者向协调者发送了No响应，或者等待超时之后，协调者都没有接到参与者的响应，那么就执行事务的中断。
    1. **发送中断请求**：协调者向所有参与者发送abort请求。
    2. **中断事务**：参与者收到来自协调者的abort请求之后（或超时之后，仍未收到协调者的请求），执行事务的中断。

### 第三阶段（doCommit阶段）

分为以下两种情况——

* 执行提交
    1. **发送提交请求**：协调接收到参与者发送的ACK响应，那么他将从预提交状态进入到提交状态。并向所有参与者发送doCommit请求。
    2. **事务提交**：参与者接收到doCommit请求之后，执行正式的事务提交。并在完成事务提交之后释放所有事务资源。
    3. **响应反馈**：事务提交完之后，向协调者发送Ack响应。
    4. **完成事务**：协调者接收到所有参与者的ack响应之后，完成事务。

* 中断事务
    1. **发送中断请求**：协调者向所有参与者发送abort请求
    2. **事务回滚**：参与者接收到abort请求之后，利用其在阶段二记录的undo信息来执行事务的回滚操作，并在完成回滚之后释放所有的事务资源。
    3. **反馈结果**：参与者完成事务回滚之后，向协调者发送ACK消息
    4. **中断事务**：协调者接收到参与者反馈的ACK消息之后，执行事务的中断。

## 优点同时也带来缺点

相对于2PC，3PC主要解决的单点故障问题，并减少阻塞，因为一旦参与者无法及时收到来自协调者的信息之后，他会默认执行commit。而不会一直持有事务资源并处于阻塞状态。

但是这种机制也会导致数据一致性问题，因为，由于网络原因，协调者发送的abort响应没有及时被参与者接收到，那么参与者在等待超时之后执行了commit操作。这样就和其他接到abort命令并执行回滚的参与者之间存在数据不一致的情况。